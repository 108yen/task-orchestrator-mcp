# 実装計画

- [x] 1. データ永続化層の実装
  - Task型定義とストレージ機能の基盤を構築する
  - 環境変数に基づくファイル/インメモリ永続化の切り替え機能を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.1 Task型定義とストレージインターフェースの作成
  - `src/storage.ts`にTask型とreadTasks/writeTasks関数を実装する
  - FILE_PATH環境変数の有無による動作分岐を実装する
  - _Requirements: 4.1, 4.2_

- [x] 1.2 ストレージ機能のユニットテスト実装
  - `src/storage.test.ts`を作成し、fsモジュールをモック化してテストする
  - ファイル永続化とインメモリモードの両方の動作を検証する
  - _Requirements: 4.3, 4.4, 4.5_

- [ ] 1.3 データ永続化層の品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 2. コアビジネスロジックの実装
  - タスクのCRUD操作と実行管理機能を実装する
  - 階層構造と実行順序の管理ロジックを構築する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2.1 基本CRUD操作の実装
  - `src/task.ts`にcreateTask, getTask, listTasks, updateTask, deleteTask関数を実装する
  - 一意ID生成、タイムスタンプ管理、親子関係の確立機能を含める
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 タスク実行管理機能の実装
  - startTaskとcompleteTask関数を実装する
  - ステータス変更、次タスク特定、実行順序制御のロジックを構築する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2.3 ビジネスロジックのユニットテスト実装
  - `src/task.test.ts`を作成し、storage.tsをモック化してテストする
  - 各ツール関数の動作とエラーハンドリングを検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 2.4 コアビジネスロジックの品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 3. MCPサーバーとツール登録の実装
  - McpServerインスタンスの作成とツール登録機能を実装する
  - MCP準拠のツールインターフェースを構築する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3.1 MCPサーバーインスタンスの作成
  - `src/server.ts`でMcpServerインスタンスを作成し、プロジェクト情報を設定する
  - サーバー設定とエクスポート機能を実装する
  - _Requirements: 5.1_

- [x] 3.2 ツール登録機能の実装
  - `src/tools.ts`でregisterTools関数を実装する
  - task.tsの各関数をMCPツールとして登録する機能を構築する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3.3 ツール登録のユニットテスト実装
  - `src/tools.test.ts`を作成し、McpServerのregisterToolメソッドをスパイしてテストする
  - 全ツールの正常登録を検証する
  - _Requirements: 5.1, 5.2_

- [x] 3.4 MCPサーバーとツール登録の品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 4. アプリケーションエントリーポイントの実装
  - サーバー起動とトランスポート接続機能を実装する
  - StdioServerTransportを使用した通信機能を構築する
  - _Requirements: 5.5_

- [x] 4.1 メインエントリーポイントの作成
  - `src/index.ts`でrun関数を実装する
  - サーバー起動、ツール登録、StdioServerTransport接続を統合する
  - _Requirements: 5.5_

- [x] 4.2 エントリーポイントの動作確認
  - アプリケーション全体の起動テストを実行する
  - 基本的な統合動作を確認する
  - _Requirements: 5.5_

- [x] 4.3 アプリケーションエントリーポイントの品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [ ] 5. 統合テストと最終検証
  - 全モジュール連携での動作確認を実施する
  - エラーハンドリングと境界値テストを実行する
  - _Requirements: 全要件の統合検証_

- [x] 5.1 統合テストの実装
  - 複数モジュール連携でのデータフロー検証テストを作成する
  - tools → task → storageの一連の処理を確認する
  - _Requirements: 全要件の統合検証_

- [x] 5.2 エラーハンドリングテストの実装
  - バリデーションエラー、データ整合性エラー、I/Oエラーのテストを作成する
  - 各エラーケースでの適切なレスポンス返却を検証する
  - _Requirements: 全要件のエラーケース検証_

- [ ] 5.3 タスクステータス表示テーブルの統一と拡張
  - startTaskとcompleteTask関数で出力されるテーブルの形式を統一する
  - テーブルにステータス変更列を追加し、その操作でステータスが変更されたタスクを明示する
  - テーブルに親タスク列を追加し、各タスクの親タスク名を表示する
  - _Requirements: 3.4, 3.9_

- [ ] 5.4 最終品質チェック
  - `pnpm quality`を実行してプロジェクト全体の品質を確認する
  - 全てのlint、format、typecheck、testエラーを修正する
  - リリース準備のための最終コード品質保証を実施する
  - _Requirements: 全体的なコード品質保証_

- [x] 6. completeTask関数の進捗サマリー機能拡張
  - completeTask関数の戻り値に進捗サマリー機能を追加する
  - タスク完了時に全体の進捗状況をテーブル形式で表示する機能を実装する
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 6.1 進捗サマリー機能の実装
  - completeTask関数の戻り値にprogress_summaryフィールドを追加する
  - 全体統計（総タスク数、完了済み数、進行中数、未着手数、完了率）を計算する機能を実装する
  - 階層別進捗テーブル生成機能を実装する（親タスクごとのサブタスク進捗状況）
  - マークダウンテーブル形式での進捗表示機能を実装する
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 6.2 進捗サマリー機能のユニットテスト実装
  - completeTask関数の進捗サマリー生成機能のテストを追加する
  - 階層構造での進捗計算の正確性を検証する
  - マークダウンテーブル生成の正確性を検証する
  - 全体統計計算の正確性を検証する
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 6.3 進捗サマリー機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 7. startTask関数のネストサブタスク自動開始機能拡張
  - startTask関数を再帰的なネストサブタスク処理に対応させる
  - 最も深い階層の未完了タスクまでの中間階層も含めて自動開始する機能を実装する
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.1 ネストサブタスク自動開始機能の実装
  - findDeepestIncompleteSubtask再帰関数を実装し、最も深い未完了サブタスクを特定する機能を追加する
  - startTask関数を修正し、中間階層のタスクを含めて実行パス上のすべてのタスクのステータスを更新する
  - 階層の深さに応じた適切なメッセージ生成機能を実装する
  - startTask関数の戻り値に階層構造サマリー機能を追加検討する
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.2 ネストサブタスク自動開始機能のユニットテスト実装
  - startTask関数の多階層ネスト処理のテストケースを追加する
  - 3階層以上の深いネストでの動作確認テストを実装する
  - 完了済みタスクのスキップ機能の正確性を検証する
  - 混合階層深度での処理の正確性を検証する
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.3 ネストサブタスク自動開始機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 8. startTask関数の階層構造サマリー表示機能の実装
  - startTask関数の戻り値に階層構造サマリー機能を追加する
  - エージェントがタスク階層構造と現在の実行状況を把握できるテーブル表示機能を実装する
  - _Requirements: 3.12_

- [x] 8.1 階層構造サマリー生成機能の実装
  - startTask関数にhierarchy_summaryフィールドを追加する
  - タスク階層をテーブル形式で表示する機能を実装する
  - 各タスクのネストレベルとステータスを視覚的に表示する機能を実装する
  - _Requirements: 3.12_

- [x] 8.2 階層構造サマリーのユニットテスト実装
  - startTask関数の階層構造サマリー生成のテストケースを追加する
  - 多階層ネストでのテーブル表示の正確性を検証する
  - 階層の深さとインデントの正確性を検証する
  - _Requirements: 3.12_

- [x] 8.3 階層構造サマリー機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 9. completeTask関数の階層管理機能拡張
  - completeTask関数にサブタスク完了検証と親タスク自動完了機能を追加する
  - 階層構造の整合性を保つため、完了時の検証と連鎖処理を実装する
  - _Requirements: 3.13, 3.14_

- [x] 9.1 サブタスク完了検証機能の実装
  - completeTask関数にサブタスク完了状況の事前チェック機能を追加する
  - 未完了のサブタスクが存在する場合のエラー発生とタスク完了操作拒否機能を実装する
  - サブタスクがすべて完了している場合のみタスク完了を許可する検証ロジックを実装する
  - _Requirements: 3.13_

- [x] 9.2 親タスク自動完了機能の実装
  - タスク完了時に親タスクのサブタスク完了状況をチェックする機能を実装する
  - 親タスクの全サブタスクが完了している場合の自動完了処理を実装する
  - 階層の上位に向かって再帰的に親タスクを完了させる連鎖処理を実装する
  - _Requirements: 3.14_

- [x] 9.3 階層管理機能のユニットテスト実装
  - サブタスク完了検証機能のテストケースを追加する
  - 親タスク自動完了機能のテストケースを追加する
  - 多階層での連鎖完了処理の正確性を検証する
  - エラー発生とタスク完了操作拒否の動作を検証する
  - _Requirements: 3.13, 3.14_

- [x] 9.4 階層管理機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 10. フィールド名の統一とin_progressステータス制約の実装
  - `parent_id`を`parentId`に変更し、フィールド名の一貫性を確保する
  - `in_progress`ステータスの制約を実装し、末端ノードのみ一つだけ許可する
  - _Requirements: 3.15, 3.16_

- [x] 10.1 フィールド名の統一
  - Task型定義の`parent_id`を`parentId`に変更する
  - 関連するすべての関数とインターフェースを更新する
  - 既存のテストを修正して新しいフィールド名に対応させる
  - _Requirements: コード一貫性_

- [x] 10.2 in_progressステータス制約の実装
  - startTask関数を修正し、末端ノード（サブタスクを持たないタスク）のうち一つだけが'in_progress'ステータスを持つよう制約を追加する
  - 既に別の末端ノードが'in_progress'の場合、そのノードを'todo'に戻す機能を実装する
  - 親ノードは子ノードが'in_progress'の場合に限り'in_progress'ステータスになるよう実装する
  - _Requirements: 3.15_

- [x] 10.3 親ノードステータス更新機能の強化
  - startTask関数を修正し、タスク開始時にそのタスクの全ての親ノード（直接の親から最上位の親まで）のステータスを'in_progress'に更新する機能を実装する
  - 階層をさかのぼって親ノードを特定し、ステータスを更新する再帰関数を実装する
  - _Requirements: 3.16_

- [x] 10.4 新機能のユニットテスト実装
  - フィールド名変更に関するテストを更新する
  - in_progressステータス制約のテストケースを追加する
  - 複数の末端ノードがある場合の動作を検証する
  - 親ノードステータス更新機能のテストケースを追加する
  - 多階層構造での親ノード更新の正確性を検証する
  - _Requirements: 3.15, 3.16_

- [x] 10.5 新機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 11. タスクステータス表示テーブルの統一と拡張
  - startTaskとcompleteTask関数で出力されるテーブル形式を統一する
  - _Requirements: 3.4, 3.9_

- [x] 11.1 インターフェース定義の拡張
  - TaskProgressRowインターフェースにparent_nameとstatus_changedフィールドを追加する
  - HierarchySummaryRowインターフェースにparent_nameとstatus_changedフィールドを追加する
  - 両インターフェースの型定義を更新し、ドキュメントコメントを追加する
  - _Requirements: 3.4, 3.9_

- [x] 11.2 テーブル生成関数の拡張
  - generateProgressRows関数を修正し、親タスク名とステータス変更情報を含めるようにする
  - generateHierarchySummaryRows関数を修正し、親タスク名とステータス変更情報を含めるようにする
  - ステータス変更を追跡するためのメカニズムを実装する
  - _Requirements: 3.4, 3.9_

- [x] 11.3 テーブル表示形式の統一
  - generateMarkdownTable関数を修正し、新しい列（Parent Task、Status Changed）を含めるようにする
  - generateHierarchyMarkdownTable関数を修正し、新しい列を含めるようにする
  - 両関数のテーブルヘッダーとセパレーターを統一する
  - _Requirements: 3.4, 3.9_

- [x] 11.4 テーブル表示機能のユニットテスト実装
  - 拡張されたテーブル生成機能のテストケースを追加する
  - 親タスク名表示の正確性を検証する
  - ステータス変更表示の正確性を検証する
  - 複雑な階層構造での表示を検証する
  - _Requirements: 3.4, 3.9_

- [x] 11.5 テーブル表示機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 12. テーブルデータにすべてのタスクを含む機能の実装
  - startTaskとcompleteTask関数で返されるテーブルデータを拡張し、すべてのタスクのデータを含めるようにする
  - _Requirements: 3.4, 3.9_

- [x] 12.1 テーブル生成ロジックの分析と設計
  - 現在のstartTaskとcompleteTask関数で使用されているテーブル生成ロジックを分析する
  - すべてのタスクを含むテーブル生成の設計を策定する
  - パフォーマンスへの影響を評価し、最適化手法を検討する
  - _Requirements: 3.4, 3.9_

- [x] 12.2 全タスク取得機能の実装
  - storage.tsから全タスクを取得する汎用的な関数を実装する
  - タスクの階層構造を維持しながら効率的にデータを取得する機能を構築する
  - 大量のタスクデータに対する処理効率を最適化する
  - _Requirements: 3.4, 3.9_

- [x] 12.3 startTask関数のテーブル生成拡張
  - startTask関数内のテーブル生成ロジックを修正し、すべてのタスクを含めるようにする
  - ステータス変更されたタスクの識別機能を維持する
  - 階層構造とタスク関係の表示を保持する
  - テーブルの可読性とパフォーマンスを確保する
  - _Requirements: 3.4_

- [x] 12.4 completeTask関数のテーブル生成拡張
  - completeTask関数内のテーブル生成ロジックを修正し、すべてのタスクを含めるようにする
  - 進捗サマリーテーブルにすべてのタスクの状況を反映する
  - 完了処理によるステータス変更の追跡機能を維持する
  - 統計情報の正確性を確保する
  - _Requirements: 3.9_

- [x] 12.5 テーブル表示の一貫性確保
  - startTaskとcompleteTaskで出力されるテーブル形式の完全な統一を実現する
  - 列の順序、表示形式、データの並び順を一致させる
  - 両関数で同じヘルパー関数を使用するようリファクタリングする
  - _Requirements: 3.4, 3.9_

- [x] 12.6 拡張されたテーブル表示機能のユニットテスト実装
  - すべてのタスクを含むテーブル生成のテストケースを作成する
  - 大量のタスクデータでのテーブル生成性能を検証する
  - 複雑な階層構造でのテーブル表示の正確性を確認する
  - startTaskとcompleteTaskのテーブル出力の一貫性を検証する
  - _Requirements: 3.4, 3.9_

- [x] 12.7 統合テストの実装
  - 実際のMCPクライアントを使用した統合テストを作成する
  - すべてのタスクを含むテーブル出力の正確性を検証する
  - 大規模なタスク階層での動作を確認する
  - エラーハンドリングとエッジケースのテストを実装する
  - _Requirements: 3.4, 3.9_

- [x] 12.8 品質チェックと最終検証
  - `pnpm quality`を実行してコード品質を確認する
  - 全テストが成功することを確認する
  - ドキュメントとの整合性を検証する
  - エラーや警告の修正を完了する
  - _Requirements: コード品質保証_

- [ ] 13. タスク開始時の実行順序検証機能の実装
  - startTask関数に実行順序の妥当性検証ロジックを追加する
  - 同じ階層でorderが小さいタスクの完了状況をチェックする機能を実装する
  - _Requirements: 3.2_

- [ ] 13.1 実行順序検証ロジックの実装
  - startTask関数内に兄弟タスクの順序検証機能を追加する
  - 開始対象タスクより小さいorder値を持つ兄弟タスクの完了状況をチェックする
  - 未完了のより小さいorderタスクが存在する場合にエラーを返すロジックを実装する
  - エラーメッセージには完了すべきタスクの詳細情報を含める
  - _Requirements: 3.2_

- [ ] 13.2 実行順序検証のエラーハンドリング実装
  - 実行順序エラーの詳細なエラーメッセージ生成機能を実装する
  - 未完了タスクのリスト表示機能を追加する
  - エラー発生時の適切なレスポンス形式を確保する
  - _Requirements: 3.2_

- [ ] 13.3 実行順序検証機能のユニットテスト実装
  - 正常ケース（順序通りの実行）のテストケースを作成する
  - エラーケース（順序違反の実行）のテストケースを作成する
  - 複雑な階層構造での順序検証のテストケースを追加する
  - エラーメッセージの内容と形式を検証するテストを実装する
  - _Requirements: 3.2_

- [ ] 13.4 統合テストでの実行順序検証の検証
  - 実際のMCPクライアントを使用した実行順序検証の統合テストを作成する
  - 順序違反シナリオでの適切なエラー処理を確認する
  - エッジケースでの動作を検証する
  - _Requirements: 3.2_

- [ ] 13.5 品質チェックと最終検証
  - `pnpm quality`を実行してコード品質を確認する
  - 全テストが成功することを確認する
  - ドキュメントとの整合性を検証する
  - エラーや警告の修正を完了する
  - _Requirements: コード品質保証_
