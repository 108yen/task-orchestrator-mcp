## 新規実装：データ構造変更 (ネスト構造への移行)

- [x] 15. データ構造変更の実装
  - フラットな配列 + parentId 構造から、完全なネスト構造（tasks配列）への移行
  - parentId と order フィールドを削除し、配列インデックスで順序を管理
  - _Requirements: 新データ構造仕様_

- [x] 15.1 Task型インターフェースの更新
  - `src/storage.ts` の Task インターフェースを新しい構造に更新
  - `parentId` と `order` フィールドを削除
  - `tasks: Task[]` フィールドを追加（既に完了済み）
  - 関連インターフェース（HierarchySummaryRow, TaskProgressRow）の調整
  - _対象ファイル: src/storage.ts_

- [x] 15.2 ストレージ層の調整
  - `readTasks()` と `writeTasks()` 関数の実装を新しいネスト構造に対応
  - ファイル永続化時のJSON構造をネスト形式に変更
  - 日付変換処理を再帰的なネスト構造に対応
  - _対象ファイル: src/storage.ts_

- [x] 15.3 タスク検索・操作の基盤関数の実装
  - 再帰的なタスク検索関数 `findTaskById(tasks: Task[], id: string)` の実装
  - 親タスク検索関数 `findParentTask(tasks: Task[], targetId: string)` の実装
  - 全タスクフラット化関数 `flattenTasks(tasks: Task[])` の実装
  - タスク階層パス取得関数 `getTaskPath(tasks: Task[], id: string)` の実装
  - _対象ファイル: src/task.ts（新規ヘルパー関数群）_

- [x] 15.4 createTask 関数の完全リファクタリング
  - パラメータを `{ name, description, parentId, insertIndex }` に変更
  - `order` フィールドの削除と配列挿入ロジックへの変更
  - 親タスクの `tasks` 配列への直接挿入処理の実装
  - 兄弟タスクのシフト処理（挿入位置指定時）の実装
  - ルートタスク作成時の推奨メッセージ機能の維持
  - _対象ファイル: src/task.ts_

- [x] 15.5 getTask 関数の更新
  - フラット検索から再帰的検索への変更
  - `findTaskById` ヘルパー関数の活用
  - 戻り値にサブタスク情報を含む完全なタスクオブジェクトの返却
  - _対象ファイル: src/task.ts_

- [x] 15.6 listTasks 関数の更新
  - `parentId` パラメータによる階層レベルでのフィルタリング
  - ルートレベル取得（parentId未指定時）の実装
  - 指定された親タスクの直接の子タスクのみを返却する機能
  - _対象ファイル: src/task.ts_

- [x] 15.7 updateTask 関数の更新
  - `parentId` と `order` フィールドの更新機能を削除
  - 再帰的なタスク検索と更新処理への変更
  - 循環参照チェックの新しい構造への対応
  - _対象ファイル: src/task.ts_

- [x] 15.8 deleteTask 関数の更新
  - 親タスクの `tasks` 配列からの削除処理
  - 再帰的なサブタスク削除の実装
  - 孤立タスクの防止とカスケード削除の実装
  - _対象ファイル: src/task.ts_

- [x] 15.9 実行順序検証ロジックの更新
  - `order` 値比較から配列インデックス比較への変更
  - 同一親タスクの `tasks` 配列内での前方タスク完了チェック
  - エラーメッセージの配列位置ベースへの更新
  - _対象ファイル: src/task.ts (startTask 関数内)_

- [x] 15.10 startTask 関数の更新
  - 実行順序検証の新しいロジックへの変更
  - 最深サブタスク自動開始の再帰処理の更新
  - 親ノードステータス更新の新しい階層構造への対応
  - 階層構造表示テーブル生成の更新
  - _対象ファイル: src/task.ts_

- [x] 15.11 completeTask 関数の更新
  - サブタスク完了状況確認の `tasks` 配列ベースへの変更
  - 親タスク自動完了処理の新しい階層構造への対応
  - 次タスク特定ロジックの配列インデックスベースへの変更
  - 進捗サマリー生成の新しい構造への対応
  - _対象ファイル: src/task.ts_

- [x] 15.12 進捗・階層表示関数群の更新
  - `generateProgressRows` 関数の新しい構造への対応
  - `generateHierarchySummaryRows` 関数の再帰処理更新
  - `calculateSubtaskInfo` 関数の `tasks` 配列ベースへの変更
  - テーブル生成における親タスク表示の更新
  - _対象ファイル: src/task.ts_

- [x] 15.13 MCPツールスキーマの更新
  - `createTask` ツールのパラメータスキーマ更新（`order` → `insertIndex`）
  - `updateTask` ツールから `order` と `parentId` パラメータを削除
  - `listTasks` ツールの説明文更新（新しい階層構造に対応）
  - ツールの説明文を新しいワークフローに合わせて更新
  - _対象ファイル: src/tools.ts_

- [x] 15.14 ストレージ層のユニットテスト更新
  - 新しいTask型インターフェースに対応したテストデータの作成
  - ネスト構造でのファイル永続化テストの実装
  - 日付変換処理の再帰的処理テスト
  - _対象ファイル: src/storage.test.ts_

- [x] 15.15 ビジネスロジックのユニットテスト更新
  - 全てのタスク操作関数のテストを新しい構造に対応
  - モックデータの階層構造への変更
  - 実行順序検証テストの配列インデックスベースへの更新
  - エラーメッセージテストの新しい形式への対応
  - _対象ファイル: src/task.test.ts_

- [x] 15.16 統合テストの更新
  - 基本操作テストの新しい構造への対応
  - 階層操作テストの `tasks` 配列ベースへの変更
  - 実行順序テストの配列インデックスベースへの更新
  - ワークフローテストの新しいデータ構造への対応
  - _対象ファイル: test/integration/\*.test.ts_

- [x] 15.17 エラーハンドリングの更新
  - 循環参照チェックの新しい階層構造への対応
  - 存在しない親タスクエラーの新しい検索方式への変更
  - 配列インデックス範囲外エラーの追加
  - エラーメッセージの一貫性確保（位置ベース表記）
  - _対象ファイル: src/task.ts（各関数のエラーハンドリング）_

- [x] 15.18 品質チェックとリファクタリング
  - `pnpm quality` による全体的な品質チェック
  - TypeScript型エラーの修正
  - ESLint警告の解消
  - テストカバレッジの確認と改善
  - コード重複の除去とヘルパー関数の最適化

## 新規実装：createTaskバッチ作成機能

- [ ] 16. createTaskサブタスク同時作成機能の実装
  - createTask関数を拡張し、メインタスクと同時にサブタスクを作成
  - nameパラメータ（必須）でメインタスクを作成し、tasksパラメータでサブタスクを追加
  - _Requirements: Requirement 6（サブタスク同時作成）_

- [ ] 16.1 createTask関数の拡張実装
  - `name`パラメータ（必須）を使用してメインタスクを作成
  - `tasks`配列が指定された場合、メインタスクのサブタスクとして追加
  - 戻り値: `{ task: Task, message?: string }`（サブタスクを含む完全な構造）
  - _対象ファイル: src/task.ts（createTask関数）_

- [ ] 16.2 サブタスク再帰作成ロジックの実装
  - `tasks`配列の各要素をメインタスクのサブタスクとして追加
  - 各サブタスクの`tasks`プロパティに含まれるサブタスクの再帰的作成
  - IDが存在しない場合の新しいUUID生成ロジック
  - 既存IDの重複チェックと重複回避処理
  - _対象ファイル: src/task.ts（createTask関数内）_

- [ ] 16.3 エラーハンドリングの実装
  - nameパラメータの必須チェック
  - 詳細なエラーメッセージとエラー発生位置の特定
  - _対象ファイル: src/task.ts（createTask関数内）_

- [ ] 16.4 MCPツールスキーマの更新
  - createTaskツールのパラメータスキーマを更新
  - nameパラメータを必須に変更
  - Task配列のZodスキーマ定義（再帰的構造に対応）
  - 戻り値スキーマを単一Taskオブジェクトに変更
  - _対象ファイル: src/tools.ts_

- [ ] 16.5 ユニットテスト実装
  - メインタスクのみ作成のテスト
  - メインタスク+サブタスク作成のテスト（ネスト構造を含む）
  - エラーケースのテスト（nameなし、不正パラメータ）
  - ID保持・生成ロジックのテスト
  - _対象ファイル: src/task.test.ts_

- [ ] 16.6 統合テスト実装
  - MCP クライアントを使用したエンドツーエンドテスト
  - 複雑な階層構造の作成と検証
  - ファイル永続化モードでのテスト
  - _対象ファイル: test/integration/task-creation.test.ts_

- [ ] 16.7 ドキュメント更新と品質チェック
  - README.mdにサブタスク同時作成機能の使用例を追加
  - `pnpm quality` による全体的な品質チェック
  - TypeScript型エラーの修正とESLint警告の解消
  - テストカバレッジの確認（90%以上）
  - _対象ファイル: README.md, 全対象ファイル_
