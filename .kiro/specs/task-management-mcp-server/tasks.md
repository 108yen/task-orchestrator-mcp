# 実装計画

- [x] 1. データ永続化層の実装
  - Task型定義とストレージ機能の基盤を構築する
  - 環境変数に基づくファイル/インメモリ永続化の切り替え機能を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.1 Task型定義とストレージインターフェースの作成
  - `src/storage.ts`にTask型とreadTasks/writeTasks関数を実装する
  - FILE_PATH環境変数の有無による動作分岐を実装する
  - _Requirements: 4.1, 4.2_

- [x] 1.2 ストレージ機能のユニットテスト実装
  - `src/storage.test.ts`を作成し、fsモジュールをモック化してテストする
  - ファイル永続化とインメモリモードの両方の動作を検証する
  - _Requirements: 4.3, 4.4, 4.5_

- [ ] 1.3 データ永続化層の品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 2. コアビジネスロジックの実装
  - タスクのCRUD操作と実行管理機能を実装する
  - 階層構造と実行順序の管理ロジックを構築する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2.1 基本CRUD操作の実装
  - `src/task.ts`にcreateTask, getTask, listTasks, updateTask, deleteTask関数を実装する
  - 一意ID生成、タイムスタンプ管理、親子関係の確立機能を含める
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 タスク実行管理機能の実装
  - startTaskとcompleteTask関数を実装する
  - ステータス変更、次タスク特定、実行順序制御のロジックを構築する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2.3 ビジネスロジックのユニットテスト実装
  - `src/task.test.ts`を作成し、storage.tsをモック化してテストする
  - 各ツール関数の動作とエラーハンドリングを検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 2.4 コアビジネスロジックの品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 3. MCPサーバーとツール登録の実装
  - McpServerインスタンスの作成とツール登録機能を実装する
  - MCP準拠のツールインターフェースを構築する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3.1 MCPサーバーインスタンスの作成
  - `src/server.ts`でMcpServerインスタンスを作成し、プロジェクト情報を設定する
  - サーバー設定とエクスポート機能を実装する
  - _Requirements: 5.1_

- [x] 3.2 ツール登録機能の実装
  - `src/tools.ts`でregisterTools関数を実装する
  - task.tsの各関数をMCPツールとして登録する機能を構築する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3.3 ツール登録のユニットテスト実装
  - `src/tools.test.ts`を作成し、McpServerのregisterToolメソッドをスパイしてテストする
  - 全ツールの正常登録を検証する
  - _Requirements: 5.1, 5.2_

- [x] 3.4 MCPサーバーとツール登録の品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 4. アプリケーションエントリーポイントの実装
  - サーバー起動とトランスポート接続機能を実装する
  - StdioServerTransportを使用した通信機能を構築する
  - _Requirements: 5.5_

- [x] 4.1 メインエントリーポイントの作成
  - `src/index.ts`でrun関数を実装する
  - サーバー起動、ツール登録、StdioServerTransport接続を統合する
  - _Requirements: 5.5_

- [x] 4.2 エントリーポイントの動作確認
  - アプリケーション全体の起動テストを実行する
  - 基本的な統合動作を確認する
  - _Requirements: 5.5_

- [x] 4.3 アプリケーションエントリーポイントの品質チェック
  - `pnpm quality`を実行してlint、format、typecheck、testを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [ ] 5. 統合テストと最終検証
  - 全モジュール連携での動作確認を実施する
  - エラーハンドリングと境界値テストを実行する
  - _Requirements: 全要件の統合検証_

- [x] 5.1 統合テストの実装
  - 複数モジュール連携でのデータフロー検証テストを作成する
  - tools → task → storageの一連の処理を確認する
  - _Requirements: 全要件の統合検証_

- [x] 5.2 エラーハンドリングテストの実装
  - バリデーションエラー、データ整合性エラー、I/Oエラーのテストを作成する
  - 各エラーケースでの適切なレスポンス返却を検証する
  - _Requirements: 全要件のエラーケース検証_

- [ ] 5.3 タスクステータス表示テーブルの統一と拡張
  - startTaskとcompleteTask関数で出力されるテーブルの形式を統一する
  - テーブルにステータス変更列を追加し、その操作でステータスが変更されたタスクを明示する
  - テーブルに親タスク列を追加し、各タスクの親タスク名を表示する
  - _Requirements: 3.4, 3.9_

- [ ] 5.4 最終品質チェック
  - `pnpm quality`を実行してプロジェクト全体の品質を確認する
  - 全てのlint、format、typecheck、testエラーを修正する
  - リリース準備のための最終コード品質保証を実施する
  - _Requirements: 全体的なコード品質保証_

- [x] 6. completeTask関数の進捗サマリー機能拡張
  - completeTask関数の戻り値に進捗サマリー機能を追加する
  - タスク完了時に全体の進捗状況をテーブル形式で表示する機能を実装する
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 6.1 進捗サマリー機能の実装
  - completeTask関数の戻り値にprogress_summaryフィールドを追加する
  - 全体統計（総タスク数、完了済み数、進行中数、未着手数、完了率）を計算する機能を実装する
  - 階層別進捗テーブル生成機能を実装する（親タスクごとのサブタスク進捗状況）
  - マークダウンテーブル形式での進捗表示機能を実装する
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 6.2 進捗サマリー機能のユニットテスト実装
  - completeTask関数の進捗サマリー生成機能のテストを追加する
  - 階層構造での進捗計算の正確性を検証する
  - マークダウンテーブル生成の正確性を検証する
  - 全体統計計算の正確性を検証する
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 6.3 進捗サマリー機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 7. startTask関数のネストサブタスク自動開始機能拡張
  - startTask関数を再帰的なネストサブタスク処理に対応させる
  - 最も深い階層の未完了タスクまでの中間階層も含めて自動開始する機能を実装する
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.1 ネストサブタスク自動開始機能の実装
  - findDeepestIncompleteSubtask再帰関数を実装し、最も深い未完了サブタスクを特定する機能を追加する
  - startTask関数を修正し、中間階層のタスクを含めて実行パス上のすべてのタスクのステータスを更新する
  - 階層の深さに応じた適切なメッセージ生成機能を実装する
  - startTask関数の戻り値に階層構造サマリー機能を追加検討する
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.2 ネストサブタスク自動開始機能のユニットテスト実装
  - startTask関数の多階層ネスト処理のテストケースを追加する
  - 3階層以上の深いネストでの動作確認テストを実装する
  - 完了済みタスクのスキップ機能の正確性を検証する
  - 混合階層深度での処理の正確性を検証する
  - _Requirements: 3.2, 3.3, 3.4_

- [x] 7.3 ネストサブタスク自動開始機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 8. startTask関数の階層構造サマリー表示機能の実装
  - startTask関数の戻り値に階層構造サマリー機能を追加する
  - エージェントがタスク階層構造と現在の実行状況を把握できるテーブル表示機能を実装する
  - _Requirements: 3.12_

- [x] 8.1 階層構造サマリー生成機能の実装
  - startTask関数にhierarchy_summaryフィールドを追加する
  - タスク階層をテーブル形式で表示する機能を実装する
  - 各タスクのネストレベルとステータスを視覚的に表示する機能を実装する
  - _Requirements: 3.12_

- [x] 8.2 階層構造サマリーのユニットテスト実装
  - startTask関数の階層構造サマリー生成のテストケースを追加する
  - 多階層ネストでのテーブル表示の正確性を検証する
  - 階層の深さとインデントの正確性を検証する
  - _Requirements: 3.12_

- [x] 8.3 階層構造サマリー機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 9. completeTask関数の階層管理機能拡張
  - completeTask関数にサブタスク完了検証と親タスク自動完了機能を追加する
  - 階層構造の整合性を保つため、完了時の検証と連鎖処理を実装する
  - _Requirements: 3.13, 3.14_

- [x] 9.1 サブタスク完了検証機能の実装
  - completeTask関数にサブタスク完了状況の事前チェック機能を追加する
  - 未完了のサブタスクが存在する場合のエラー発生とタスク完了操作拒否機能を実装する
  - サブタスクがすべて完了している場合のみタスク完了を許可する検証ロジックを実装する
  - _Requirements: 3.13_

- [x] 9.2 親タスク自動完了機能の実装
  - タスク完了時に親タスクのサブタスク完了状況をチェックする機能を実装する
  - 親タスクの全サブタスクが完了している場合の自動完了処理を実装する
  - 階層の上位に向かって再帰的に親タスクを完了させる連鎖処理を実装する
  - _Requirements: 3.14_

- [x] 9.3 階層管理機能のユニットテスト実装
  - サブタスク完了検証機能のテストケースを追加する
  - 親タスク自動完了機能のテストケースを追加する
  - 多階層での連鎖完了処理の正確性を検証する
  - エラー発生とタスク完了操作拒否の動作を検証する
  - _Requirements: 3.13, 3.14_

- [x] 9.4 階層管理機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 10. フィールド名の統一とin_progressステータス制約の実装
  - `parent_id`を`parentId`に変更し、フィールド名の一貫性を確保する
  - `in_progress`ステータスの制約を実装し、末端ノードのみ一つだけ許可する
  - _Requirements: 3.15, 3.16_

- [x] 10.1 フィールド名の統一
  - Task型定義の`parent_id`を`parentId`に変更する
  - 関連するすべての関数とインターフェースを更新する
  - 既存のテストを修正して新しいフィールド名に対応させる
  - _Requirements: コード一貫性_

- [x] 10.2 in_progressステータス制約の実装
  - startTask関数を修正し、末端ノード（サブタスクを持たないタスク）のうち一つだけが'in_progress'ステータスを持つよう制約を追加する
  - 既に別の末端ノードが'in_progress'の場合、そのノードを'todo'に戻す機能を実装する
  - 親ノードは子ノードが'in_progress'の場合に限り'in_progress'ステータスになるよう実装する
  - _Requirements: 3.15_

- [x] 10.3 親ノードステータス更新機能の強化
  - startTask関数を修正し、タスク開始時にそのタスクの全ての親ノード（直接の親から最上位の親まで）のステータスを'in_progress'に更新する機能を実装する
  - 階層をさかのぼって親ノードを特定し、ステータスを更新する再帰関数を実装する
  - _Requirements: 3.16_

- [x] 10.4 新機能のユニットテスト実装
  - フィールド名変更に関するテストを更新する
  - in_progressステータス制約のテストケースを追加する
  - 複数の末端ノードがある場合の動作を検証する
  - 親ノードステータス更新機能のテストケースを追加する
  - 多階層構造での親ノード更新の正確性を検証する
  - _Requirements: 3.15, 3.16_

- [x] 10.5 新機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 11. タスクステータス表示テーブルの統一と拡張
  - startTaskとcompleteTask関数で出力されるテーブル形式を統一する
  - _Requirements: 3.4, 3.9_

- [x] 11.1 インターフェース定義の拡張
  - TaskProgressRowインターフェースにparent_nameとstatus_changedフィールドを追加する
  - HierarchySummaryRowインターフェースにparent_nameとstatus_changedフィールドを追加する
  - 両インターフェースの型定義を更新し、ドキュメントコメントを追加する
  - _Requirements: 3.4, 3.9_

- [x] 11.2 テーブル生成関数の拡張
  - generateProgressRows関数を修正し、親タスク名とステータス変更情報を含めるようにする
  - generateHierarchySummaryRows関数を修正し、親タスク名とステータス変更情報を含めるようにする
  - ステータス変更を追跡するためのメカニズムを実装する
  - _Requirements: 3.4, 3.9_

- [x] 11.3 テーブル表示形式の統一
  - generateMarkdownTable関数を修正し、新しい列（Parent Task、Status Changed）を含めるようにする
  - generateHierarchyMarkdownTable関数を修正し、新しい列を含めるようにする
  - 両関数のテーブルヘッダーとセパレーターを統一する
  - _Requirements: 3.4, 3.9_

- [x] 11.4 テーブル表示機能のユニットテスト実装
  - 拡張されたテーブル生成機能のテストケースを追加する
  - 親タスク名表示の正確性を検証する
  - ステータス変更表示の正確性を検証する
  - 複雑な階層構造での表示を検証する
  - _Requirements: 3.4, 3.9_

- [x] 11.5 テーブル表示機能の品質チェック
  - `pnpm quality`を実行して新機能の品質を確認する
  - 全テストが成功することを確認する
  - 発見されたエラーや警告を修正する
  - _Requirements: コード品質保証_

- [x] 12. テーブルデータにすべてのタスクを含む機能の実装
  - startTaskとcompleteTask関数で返されるテーブルデータを拡張し、すべてのタスクのデータを含めるようにする
  - _Requirements: 3.4, 3.9_

- [x] 12.1 テーブル生成ロジックの分析と設計
  - 現在のstartTaskとcompleteTask関数で使用されているテーブル生成ロジックを分析する
  - すべてのタスクを含むテーブル生成の設計を策定する
  - パフォーマンスへの影響を評価し、最適化手法を検討する
  - _Requirements: 3.4, 3.9_

- [x] 12.2 全タスク取得機能の実装
  - storage.tsから全タスクを取得する汎用的な関数を実装する
  - タスクの階層構造を維持しながら効率的にデータを取得する機能を構築する
  - 大量のタスクデータに対する処理効率を最適化する
  - _Requirements: 3.4, 3.9_

- [x] 12.3 startTask関数のテーブル生成拡張
  - startTask関数内のテーブル生成ロジックを修正し、すべてのタスクを含めるようにする
  - ステータス変更されたタスクの識別機能を維持する
  - 階層構造とタスク関係の表示を保持する
  - テーブルの可読性とパフォーマンスを確保する
  - _Requirements: 3.4_

- [x] 12.4 completeTask関数のテーブル生成拡張
  - completeTask関数内のテーブル生成ロジックを修正し、すべてのタスクを含めるようにする
  - 進捗サマリーテーブルにすべてのタスクの状況を反映する
  - 完了処理によるステータス変更の追跡機能を維持する
  - 統計情報の正確性を確保する
  - _Requirements: 3.9_

- [x] 12.5 テーブル表示の一貫性確保
  - startTaskとcompleteTaskで出力されるテーブル形式の完全な統一を実現する
  - 列の順序、表示形式、データの並び順を一致させる
  - 両関数で同じヘルパー関数を使用するようリファクタリングする
  - _Requirements: 3.4, 3.9_

- [x] 12.6 拡張されたテーブル表示機能のユニットテスト実装
  - すべてのタスクを含むテーブル生成のテストケースを作成する
  - 大量のタスクデータでのテーブル生成性能を検証する
  - 複雑な階層構造でのテーブル表示の正確性を確認する
  - startTaskとcompleteTaskのテーブル出力の一貫性を検証する
  - _Requirements: 3.4, 3.9_

- [x] 12.7 統合テストの実装
  - 実際のMCPクライアントを使用した統合テストを作成する
  - すべてのタスクを含むテーブル出力の正確性を検証する
  - 大規模なタスク階層での動作を確認する
  - エラーハンドリングとエッジケースのテストを実装する
  - _Requirements: 3.4, 3.9_

- [x] 12.8 品質チェックと最終検証
  - `pnpm quality`を実行してコード品質を確認する
  - 全テストが成功することを確認する
  - ドキュメントとの整合性を検証する
  - エラーや警告の修正を完了する
  - _Requirements: コード品質保証_

- [x] 13. タスク開始時の実行順序検証機能の実装
  - startTask関数に実行順序の妥当性検証ロジックを追加する
  - 同じ階層でorderが小さいタスクの完了状況をチェックする機能を実装する
  - _Requirements: 3.2_

- [x] 13.1 実行順序検証ロジックの実装
  - startTask関数内に兄弟タスクの順序検証機能を追加する
  - 開始対象タスクより小さいorder値を持つ兄弟タスクの完了状況をチェックする
  - 未完了のより小さいorderタスクが存在する場合にエラーを返すロジックを実装する
  - エラーメッセージには完了すべきタスクの詳細情報を含める
  - _Requirements: 3.2_

- [x] 13.2 実行順序検証のエラーハンドリング実装
  - 実行順序エラーの詳細なエラーメッセージ生成機能を実装する
  - 未完了タスクのリスト表示機能を追加する
  - エラー発生時の適切なレスポンス形式を確保する
  - _Requirements: 3.2_

- [x] 13.3 実行順序検証機能のユニットテスト実装
  - 正常ケース（順序通りの実行）のテストケースを作成する
  - エラーケース（順序違反の実行）のテストケースを作成する
  - 複雑な階層構造での順序検証のテストケースを追加する
  - エラーメッセージの内容と形式を検証するテストを実装する
  - _Requirements: 3.2_

- [x] 13.4 統合テストでの実行順序検証の検証
  - 実際のMCPクライアントを使用した実行順序検証の統合テストを作成する
  - 順序違反シナリオでの適切なエラー処理を確認する
  - エッジケースでの動作を検証する
  - _Requirements: 3.2_

- [x] 13.5 品質チェックと最終検証
  - `pnpm quality`を実行してコード品質を確認する
  - 全テストが成功することを確認する
  - ドキュメントとの整合性を検証する
  - エラーや警告の修正を完了する
  - _Requirements: コード品質保証_

- [x] 14. startTaskテーブルフォーマットの修正
  - startTask実行時に返却されるテーブルフォーマットをcompleteTaskと同じ形式に統一する
  - _Requirements: 3.4, 3.9_

- [x] 14.1 startTaskテーブルにSubtasks/Progressカラムの追加
  - HierarchySummaryRowインターフェースにsubtasksとprogressフィールドを追加する
  - generateHierarchySummaryRows関数を修正し、各タスクのサブタスク数と進捗率を計算する機能を実装する
  - サブタスクがないタスクには"-"を表示し、あるタスクには"完了済み/総数"形式で表示する
  - 進捗率はサブタスクがないタスクはステータスに応じて0%または100%、あるタスクは完了率を計算する
  - _Requirements: 3.4, 3.9_

- [x] 14.2 startTaskテーブルのインデント削除
  - generateHierarchyMarkdownTable関数を修正し、サブタスクの不要なインデント（"　"）を削除する
  - タスク名の階層表示方法をcompleteTaskテーブルと同じ形式に統一する
  - 階層構造を維持しながら、視覚的にクリーンなテーブル表示を実現する
  - _Requirements: 3.4, 3.9_

- [x] 14.3 テーブル表示形式の完全統一
  - startTaskとcompleteTaskで出力されるテーブルのカラム順序を統一する
  - 両関数で同じヘッダー形式（Task Structure, Parent Task, Status, Status Changed, Subtasks, Progress）を使用する
  - データの表示形式とフォーマットを完全に一致させる
  - _Requirements: 3.4, 3.9_

- [x] 14.4 修正されたテーブル表示のユニットテスト実装
  - 新しいSubtasks/Progressカラムの表示内容を検証するテストケースを作成する
  - インデント削除後のテーブル表示の正確性を確認する
  - startTaskとcompleteTaskのテーブル出力の完全一致を検証する
  - 様々な階層構造での新しいテーブル形式の動作を確認する
  - _Requirements: 3.4, 3.9_

- [x] 14.5 統合テストでのテーブル形式統一の検証
  - 実際のMCPクライアントを使用してstartTaskとcompleteTaskのテーブル出力を比較する
  - テーブル形式の一貫性を検証する統合テストを作成する
  - 大規模な階層構造での新しいテーブル形式の動作を確認する
  - _Requirements: 3.4, 3.9_

- [x] 14.6 品質チェックと最終検証
  - `pnpm quality`を実行してコード品質を確認する
  - 全テストが成功することを確認する
  - テーブル表示の視覚的品質を手動で確認する
  - エラーや警告の修正を完了する
  - _Requirements: コード品質保証_

## 新規実装：データ構造変更 (ネスト構造への移行)

- [ ] 15. データ構造変更の実装
  - フラットな配列 + parentId 構造から、完全なネスト構造（tasks配列）への移行
  - parentId と order フィールドを削除し、配列インデックスで順序を管理
  - _Requirements: 新データ構造仕様_

- [ ] 15.1 Task型インターフェースの更新
  - `src/storage.ts` の Task インターフェースを新しい構造に更新
  - `parentId` と `order` フィールドを削除
  - `tasks: Task[]` フィールドを追加（既に完了済み）
  - 関連インターフェース（HierarchySummaryRow, TaskProgressRow）の調整
  - _対象ファイル: src/storage.ts_

- [ ] 15.2 ストレージ層の調整
  - `readTasks()` と `writeTasks()` 関数の実装を新しいネスト構造に対応
  - ファイル永続化時のJSON構造をネスト形式に変更
  - 日付変換処理を再帰的なネスト構造に対応
  - _対象ファイル: src/storage.ts_

- [ ] 15.3 タスク検索・操作の基盤関数の実装
  - 再帰的なタスク検索関数 `findTaskById(tasks: Task[], id: string)` の実装
  - 親タスク検索関数 `findParentTask(tasks: Task[], targetId: string)` の実装
  - 全タスクフラット化関数 `flattenTasks(tasks: Task[])` の実装
  - タスク階層パス取得関数 `getTaskPath(tasks: Task[], id: string)` の実装
  - _対象ファイル: src/task.ts（新規ヘルパー関数群）_

- [ ] 15.4 createTask 関数の完全リファクタリング
  - パラメータを `{ name, description, parentId, insertIndex }` に変更
  - `order` フィールドの削除と配列挿入ロジックへの変更
  - 親タスクの `tasks` 配列への直接挿入処理の実装
  - 兄弟タスクのシフト処理（挿入位置指定時）の実装
  - ルートタスク作成時の推奨メッセージ機能の維持
  - _対象ファイル: src/task.ts_

- [ ] 15.5 getTask 関数の更新
  - フラット検索から再帰的検索への変更
  - `findTaskById` ヘルパー関数の活用
  - 戻り値にサブタスク情報を含む完全なタスクオブジェクトの返却
  - _対象ファイル: src/task.ts_

- [ ] 15.6 listTasks 関数の更新
  - `parentId` パラメータによる階層レベルでのフィルタリング
  - ルートレベル取得（parentId未指定時）の実装
  - 指定された親タスクの直接の子タスクのみを返却する機能
  - _対象ファイル: src/task.ts_

- [ ] 15.7 updateTask 関数の更新
  - `parentId` と `order` フィールドの更新機能を削除
  - 再帰的なタスク検索と更新処理への変更
  - 循環参照チェックの新しい構造への対応
  - _対象ファイル: src/task.ts_

- [ ] 15.8 deleteTask 関数の更新
  - 親タスクの `tasks` 配列からの削除処理
  - 再帰的なサブタスク削除の実装
  - 孤立タスクの防止とカスケード削除の実装
  - _対象ファイル: src/task.ts_

- [ ] 15.9 実行順序検証ロジックの更新
  - `order` 値比較から配列インデックス比較への変更
  - 同一親タスクの `tasks` 配列内での前方タスク完了チェック
  - エラーメッセージの配列位置ベースへの更新
  - _対象ファイル: src/task.ts (startTask 関数内)_

- [ ] 15.10 startTask 関数の更新
  - 実行順序検証の新しいロジックへの変更
  - 最深サブタスク自動開始の再帰処理の更新
  - 親ノードステータス更新の新しい階層構造への対応
  - 階層構造表示テーブル生成の更新
  - _対象ファイル: src/task.ts_

- [ ] 15.11 completeTask 関数の更新
  - サブタスク完了状況確認の `tasks` 配列ベースへの変更
  - 親タスク自動完了処理の新しい階層構造への対応
  - 次タスク特定ロジックの配列インデックスベースへの変更
  - 進捗サマリー生成の新しい構造への対応
  - _対象ファイル: src/task.ts_

- [ ] 15.12 進捗・階層表示関数群の更新
  - `generateProgressRows` 関数の新しい構造への対応
  - `generateHierarchySummaryRows` 関数の再帰処理更新
  - `calculateSubtaskInfo` 関数の `tasks` 配列ベースへの変更
  - テーブル生成における親タスク表示の更新
  - _対象ファイル: src/task.ts_

- [ ] 15.13 MCPツールスキーマの更新
  - `createTask` ツールのパラメータスキーマ更新（`order` → `insertIndex`）
  - `updateTask` ツールから `order` と `parentId` パラメータを削除
  - `listTasks` ツールの説明文更新（新しい階層構造に対応）
  - ツールの説明文を新しいワークフローに合わせて更新
  - _対象ファイル: src/tools.ts_

- [ ] 15.14 ストレージ層のユニットテスト更新
  - 新しいTask型インターフェースに対応したテストデータの作成
  - ネスト構造でのファイル永続化テストの実装
  - 日付変換処理の再帰的処理テスト
  - _対象ファイル: src/storage.test.ts_

- [ ] 15.15 ビジネスロジックのユニットテスト更新
  - 全てのタスク操作関数のテストを新しい構造に対応
  - モックデータの階層構造への変更
  - 実行順序検証テストの配列インデックスベースへの更新
  - エラーメッセージテストの新しい形式への対応
  - _対象ファイル: src/task.test.ts_

- [ ] 15.16 統合テストの更新
  - 基本操作テストの新しい構造への対応
  - 階層操作テストの `tasks` 配列ベースへの変更
  - 実行順序テストの配列インデックスベースへの更新
  - ワークフローテストの新しいデータ構造への対応
  - _対象ファイル: test/integration/\*.test.ts_

- [ ] 15.17 エラーハンドリングの更新
  - 循環参照チェックの新しい階層構造への対応
  - 存在しない親タスクエラーの新しい検索方式への変更
  - 配列インデックス範囲外エラーの追加
  - エラーメッセージの一貫性確保（位置ベース表記）
  - _対象ファイル: src/task.ts（各関数のエラーハンドリング）_

- [ ] 15.18 品質チェックとリファクタリング
  - `pnpm quality` による全体的な品質チェック
  - TypeScript型エラーの修正
  - ESLint警告の解消
  - テストカバレッジの確認と改善
  - コード重複の除去とヘルパー関数の最適化

## 実装の推奨順序

上記のタスクは以下の順序で実装することを推奨します：

**フェーズ1: 基盤の更新**

1. 15.1 → 15.2 → 15.3 （データ型とヘルパー関数の整備）

**フェーズ2: CRUD操作の移行** 2. 15.4 → 15.5 → 15.6 → 15.7 → 15.8 （基本操作の順次移行）

**フェーズ3: 実行管理の移行** 3. 15.9 → 15.10 → 15.11 → 15.12 （実行フローの移行）

**フェーズ4: インターフェースと品質** 4. 15.13 → 15.17 → 15.18 （ツールスキーマとエラーハンドリング）

**フェーズ5: テストと検証** 5. 15.14 → 15.15 → 15.16 （テスト更新と最終検証）
